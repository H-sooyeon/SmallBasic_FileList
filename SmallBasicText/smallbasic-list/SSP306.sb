strSettingFile = "/home/root/lms2012/prjs/settingsIOT.rtf"

strLicenceFile = "/home/root/lms2012/prjs/LegoEV3_IOT.lic"

strAnswerFile = "/home/root/lms2012/prjs/answ.txt"



versNumber = "0.7"

versDate = "31 Jan 2016"

verDeveloper = "Alexander Feduleev"

verDevEmail = "fedalal@gmail.com"



fn3 = 0

powResult = 0

hasLicence = 0

FileValue = ""

SelectedProject = ""

FileFigure = 0

valueToSave = ""

currValue = 0

ParamsCount = 4

ParamNames[1] = "Send every sec."

ParamNames[2] = "Beep on send"

ParamNames[3] = "Blink on send"

ParamNames[4] = "Read every sec."

ParamNames[5] = ""



ParamValues[1] = 1

ParamValues[2] = 1

ParamValues[3] = 1

ParamValues[4] = 1

ParamValues[5] = 0



SensorValue[1] = 0

SensorValue[2] = 0

SensorValue[3] = 0

SensorValue[4] = 0



OldSensorValue[1] = 0

OldSensorValue[2] = 0

OldSensorValue[3] = 0

OldSensorValue[4] = 0



IoTFile[1] = ""

IoTFile[2] = ""

IoTFile[3] = ""

IoTFile[4] = ""

IoTFile[5] = ""

IoTFile[6] = ""

IoTFile[7] = ""

IoTFile[8] = ""

IoTFile[9] = ""

IoTFile[10] = ""



IoTFileCount = 0



IOT_Server = ""

IOT_ServiceName = ""

IOT_AppKey = ""

IOT_ThingName = ""



SensorName[1] = ""

SensorName[2] = ""

SensorName[3] = ""

SensorName[4] = ""



SensorType[1] = 0

SensorType[2] = 0

SensorType[3] = 0

SensorType[4] = 0



SensorMode[1] = 0

SensorMode[2] = 0

SensorMode[3] = 0

SensorMode[4] = 0



MotorSpeed[1] = 0

MotorSpeed[2] = 0

MotorSpeed[3] = 0

MotorSpeed[4] = 0





lineUp[1]="QWERTYUIOP"

lineUp[2]="ASDFGHJKL"

lineUp[3]="ZXCVBNM"



lineDown[1]="qwertyuiop"

lineDown[2]="asdfghjkl"

lineDown[3]="zxcvbnm"



lineFig[1]="1234567890"

lineFig[2]="+-=<>/\*:"

lineFig[3]="()_.@!?"



curKeyMode = 0 ' upper case letters

curTextLine1 = ""

curTextLine2 = ""

curKeyColumn = 8

curKeyRow  = 3



BrickNumber = ""

SerialCode = ""



answText = ""

subanswText = ""



StartSend = 0

StartNumber = 1

CurrNumber = 1

StartParam = 1

CurrParam = 1



StartTask = 1

CurrTask = 1



ProjectCount = 5

PrjList[1] = "Start"

PrjList[2] = "Settings"

PrjList[3] = "About"

PrjList[4] = ""

PrjList[5] = "Exit"



mytext=""

RunTime = 0

SendCount = 0 

strQuestion = ""

FileShort = ""



SensText = ""

SensType = 0

SensMode = 0

isGoodFileFormat = 0

MsgText = ""



WiFiConnected = 0 

currSensor = 1



ReadFileV[1]=""

ReadFileV[2]=""

ReadFileV[3]=""

ReadFileV[4]=""

ReadFileV[5]=""

ReadFileV[6]=""

ReadFileV[7]=""

ReadedBytes = 0



Sub ReadStringFromLCD

  'mytext=""

LCD.Clear()

LCD.Text(1,0,3,1,"BS-Backspace  OK-Enter")

'Don't confuse the EV3 enter (middle) button 

'with the '>' char on the LCD screen

line[1]="0123456789."

line[2]="ABCDEFGHIJK"

line[3]="LMNOPQRSTUV"

line[4]="WXYZ  BS OK"

LCD.Text(1,0,16,2,line[1])

LCD.Text(1,0,38,2,line[2])

LCD.Text(1,0,60,2,line[3])

LCD.Text(1,0,82,2,line[4])

LCD.Rect(1,0,103,178,25)  'draw rectangle to hold our string

col=6   'current column

row=2   'current row

x=81    'x coordinate of highlighted char 'F'

y=35    'y coordinate of highlighted char 'F'

LCD.InverseRect(x,y,16,22)   'highlight character 'F'



LCD.Text(1,1,107,2,"                 ")  'clear our text string

LCD.Text(1,1,107,1,mytext)



loop="True"   'loop control variable

While loop

  Buttons.Wait()

  Button=Buttons.GetClicks()

  

  If (row = 4 And (col = 7 Or col = 8)) Then

    x=-15+7*16 'calculate x coordinate of character to be highlighted

    LCD.InverseRect(x,y,32,22)

  ElseIf (row = 4 And (col = 10 or col = 11)) then

    x=-15+10*16 'calculate x coordinate of character to be highlighted

    LCD.InverseRect(x,y,32,22)

  Else

    LCD.InverseRect(x,y,16,22)

  EndIf

  

  If Button="R" Then

    col=1+Math.Remainder(col,11)  'allow jump from col 11 to col 1

  ElseIf Button="L" Then

    col=11-Math.Remainder(12-col,11)'allow jump from col 1 to col 11

  ElseIf Button="U" Then

    row=4-Math.Remainder(5-row,4)  'allow jump from row 4 to row 1

  ElseIf Button="D" Then

    row=1+Math.Remainder(row,4)  'allow jump from row 1 to row 4

  ElseIf Button="E" Then

    If row=4 and col>6 Then

      If col =7 or col = 8 then   'backspace

        If  mytext<>"" Then

          'remove last character from mytext

          mytext=Text.GetSubText(mytext,1,Text.GetLength(mytext)-1)

        Else  'nothing to delete

          'Speaker.Tone(100,1000,1000)

        endif

      ElseIf col = 10 or col = 11 Then   'Enter

        Loop="False"   ' do not repeat loop  

      

      Else   'col=7,8 or 10, which is not valid in row 4

        'Speaker.Tone(100,1000,1000)

      EndIf  

    Else  'middle button was pressed over a normal character

      If Text.GetLength(mytext)<>21 Then

        mytext="a"+mytext+Text.GetSubText(line[row],col,1)

        mytext = Text.GetSubTextToEnd(mytext,2)

      Else  'already have the maximum 11 characters

        Speaker.Tone(100,1500,100)

      EndIf

    EndIf

  EndIf

  x=-15+col*16 'calculate x coordinate of character to be highlighted

  y=-9+row*22  'calculate y coordinate of character to be highlighted

  

  If (row = 4 And (col = 7 Or col = 8)) Then

    x=-15+7*16 'calculate x coordinate of character to be highlighted

    LCD.InverseRect(x,y,32,22)

  ElseIf (row = 4 And (col = 10 or col = 11)) then

    x=-15+10*16 'calculate x coordinate of character to be highlighted

    LCD.InverseRect(x,y,32,22)

  Else

    LCD.InverseRect(x,y,16,22)

  EndIf



  

  LCD.Text(1,1,107,2,"                 ")  'clear our text string

  LCD.Text(1,1,107,1,mytext)

EndWhile



EndSub



Sub AboutBox

  LCD.StopUpdate()

  LCD.Clear()

  LCD.Text(1,1,10,1,"Lego EV3 IOT Tool")

  LCD.Text(1,1,35,0, "Version:" +  versNumber)

  LCD.Text(1,1,50,0, "Release:" +  versDate)

  LCD.Text(1,1,75,0, "EV3:" +  BrickNumber)

  

  LCD.Text(1,1,95,0,  verDeveloper)

  LCD.Text(1,1,110,0,  verDevEmail)

  

  

  LCD.Update()

  

  Buttons.Wait()

  Buttons.GetClicks()

EndSub



Sub GetSerialCode

  ResCode = 0

 

 n = 0

 For i = 1 To Text.GetLength(BrickNumber)

  char = Text.GetSubText(BrickNumber, Text.GetLength(BrickNumber) - i + 1, 1)

  If char = "a" Or char = "A" Then

   v = 10

  ElseIf char = "b" Or char = "B" Then

   v = 11

  ElseIf char = "c" Or char = "C" Then

   v = 12

  ElseIf char = "d" Or char = "D" Then

   v = 13

  ElseIf char = "e" Or char = "E" Then

   v = 14

  ElseIf char = "f" Or char = "F" Then

   v = 15

  Else

' The following line could be harmful and has been automatically commented.

'    v = EV3File.ConvertToNumber(char)

  EndIf



    If n = 0 Then

     powResult = 1

  Else

     For j = 1 To n

     If j = 1 Then

      powResult= 3

     Else

      powResult = powResult* 3

     EndIf

           

    EndFor

    endif

    

    ResCode= ResCode+ v * powResult

    

  n = n + 1

 EndFor

 

 ResCode= ResCode*8 -284

 SerialCode = "" + ResCode

EndSub





Sub CheckLicence

  hasLicence = 0

  'look for file with licence info



    EV3.SystemCall("ls " + strLicenceFile +"> /home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     fn2 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     FileName = EV3File.ReadLine(fn2)

' The following line could be harmful and has been automatically commented.

'     EV3File.Close(fn2)

    If FileName <> "" Then

      

' The following line could be harmful and has been automatically commented.

'     fn2 = EV3File.OpenRead(strLicenceFile)

' The following line could be harmful and has been automatically commented.

'     FileName = EV3File.ReadLine(fn2)

' The following line could be harmful and has been automatically commented.

'     EV3File.Close(fn2)

    If FileName <> "" Then

      If  SerialCode = FileName Then

        hasLicence = 1

      EndIf

    EndIf

     

    

    EndIf

    

  

    if (hasLicence = 0) Then

      ' no licence message

      

     loopEnterSerial = "true"  

 

       While loopEnterSerial 

        

      LCD.StopUpdate()

      LCD.Clear()

      

      LCD.Text(1,10,10,0,"Please enter licence")

      LCD.Text(1,10,30,0,"code for EV3 number")

      LCD.Text(1,30,50,1,BrickNumber)

      

      LCD.Text(1,10,80,2,"OK  Cancel")

      

      LCD.InverseRect(5,75,50,25)

      

      LCD.Update()

            

      buttNumber = 1      



    loop="True"   'loop control variable

   While loop

      Buttons.Wait()

      Button=Buttons.GetClicks()

  

      If Button = "E" Then

        loop = "False"

      Else

        If buttNumber = 1 then

          buttNumber = 2

         Else

           buttNumber = 1

         EndIf

         

         LCD.StopUpdate()

         LCD.InverseRect(5,75,50,25)

         LCD.InverseRect(75,75,100,25)

         LCD.Update()

      EndIf

  

   EndWhile

   

   If buttNumber = 1 Then

     'enter button

     mytext=""

      ReadStringFromLCD()

      

      If mytext = SerialCode Then

        'licence code correct

        hasLicence = 1

        loopEnterSerial = "False"

        'save licence to file



' The following line could be harmful and has been automatically commented.

'            fn2 = EV3File.OpenWrite(strLicenceFile)



' The following line could be harmful and has been automatically commented.

'            EV3File.WriteLine(fn2, SerialCode)



' The following line could be harmful and has been automatically commented.

'            EV3File.Close(fn2)





      Else

        'licence code incorrect

      EndIf

  

   Else

    'cancel

    loopEnterSerial = "False"

   EndIf

   

   EndWhile

      

    EndIf

    

    

    If hasLicence = 0 Then

      'still no licence

      LCD.Clear()

      LCD.Text(1,25,30,1,"Lego EV3 IOT tool")

      LCD.Text(1,5,50,2," Demo mode")

      Buttons.Wait()

      Buttons.GetClicks()

    EndIf

    

    

EndSub





Sub ShowMenuItems

  LCD.StopUpdate()

  

  LCD.Clear()

   For i = 0 To 5

    If ((StartNumber+i)  <= ProjectCount) Then

      LCD.Text (1, 2, 2+i*21, 2, PrjList[StartNumber+i]) 

    EndIf

  EndFor

  

  LCD.InverseRect (2, 1+(CurrNumber-1)*21, 175, 20)

  LCD.Update()

EndSub



Sub SelectMenuItem

  'show list of projects and select one 

  StartNumber = 1

  CurrNumber = 1

  

  ShowMenuItems()

  EV3.SetLEDColor ("ORANGE", "NORMAL")



  Buttons.Wait()

  K=Buttons.GetClicks()

   

    While  (K <>"E") 

        

    'Up button

    If K =  "U" Then

      CurrNumber =CurrNumber-1

      If (CurrNumber < 1 ) Then

        CurrNumber = 1

        If StartNumber > 1 Then

           StartNumber=StartNumber-1

        EndIf

       EndIf

       ShowMenuItems()

    EndIf

    

    'Down button

    If K=  "D" Then

      

      If ProjectCount > CurrNumber Then

        CurrNumber =CurrNumber+1

      EndIf

    

      If (CurrNumber > 6 ) Then

        CurrNumber = 6

        If ProjectCount > (StartNumber+5) Then

           StartNumber = StartNumber+1

        EndIf

       EndIf

       ShowMenuItems()

     EndIf

     

    

    Buttons.Wait()

    K=Buttons.GetClicks()

  

  EndWhile

  c = StartNumber+CurrNumber-1

  SelectedProject = PrjList[c]

  

 EndSub

 

Sub SaveSettings

' The following line could be harmful and has been automatically commented.

' fnSaveSettings = EV3File.OpenWrite(strSettingFile)





' The following line could be harmful and has been automatically commented.

'  EV3File.WriteLine(fnSaveSettings, "Settings v0.7") 

' The following line could be harmful and has been automatically commented.

'  EV3File.WriteByte(fnSaveSettings,10)

' The following line could be harmful and has been automatically commented.

'  EV3File.WriteByte(fnSaveSettings,13)



For i = 1 To ParamsCount

' The following line could be harmful and has been automatically commented.

'  EV3File.WriteLine(fnSaveSettings, ParamNames[i])

' The following line could be harmful and has been automatically commented.

'  EV3File.WriteByte(fnSaveSettings,10)

' The following line could be harmful and has been automatically commented.

'  EV3File.WriteByte(fnSaveSettings,13)



' The following line could be harmful and has been automatically commented.

'  EV3File.WriteLine(fnSaveSettings, ParamValues[i])

' The following line could be harmful and has been automatically commented.

'  EV3File.WriteByte(fnSaveSettings,10)

' The following line could be harmful and has been automatically commented.

'  EV3File.WriteByte(fnSaveSettings,13)



EndFor



' The following line could be harmful and has been automatically commented.

' EV3File.Close(fnSaveSettings)

EndSub



Sub GetValueFromFile

  FileValue = ""

' The following line could be harmful and has been automatically commented.

'   CharRead = EV3File.ReadByte(fn3)

  While (CharRead <> 13 And CharRead <> 0 )

    FileValue=FileValue+ Text.GetCharacter(CharRead)

' The following line could be harmful and has been automatically commented.

'     CharRead = EV3File.ReadByte(fn3)

  EndWhile

  

EndSub



Sub GetFigureFromFile

  FileValue = "a"

' The following line could be harmful and has been automatically commented.

'   CharRead = EV3File.ReadByte(fn3)

  While (CharRead <> 13 And CharRead <> 0 )

    FileValue=FileValue + Text.GetCharacter(CharRead)

' The following line could be harmful and has been automatically commented.

'     CharRead = EV3File.ReadByte(fn3)

  EndWhile

  

' The following line could be harmful and has been automatically commented.

'   FileFigure = EV3File.ConvertToNumber(Text.GetSubTextToEnd(FileValue,2))

EndSub



Sub ReadSettings

  

    EV3.SystemCall("ls " + strSettingFile +"> /home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     fn2 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     FileName = EV3File.ReadLine(fn2)

' The following line could be harmful and has been automatically commented.

'     EV3File.Close(fn2)

    If FileName <> "" Then

      'file exist

    Else

      'settings file not exist - create it by default values

      Speaker.Tone(100,1000,500)

      SaveSettings()   

    EndIf

    

      

' The following line could be harmful and has been automatically commented.

'    fn3 = EV3File.OpenRead(strSettingFile)

   GetValueFromFile()

   

   'check is this correct settings file or not

   If Text.IsSubText(FileValue ,"Settings v0.7")  Then

   Else

     

' The following line could be harmful and has been automatically commented.

'      EV3File.Close(fn3)

     SaveSettings()

' The following line could be harmful and has been automatically commented.

'      fn3 = EV3File.OpenRead(strSettingFile)

     GetValueFromFile()

   EndIf

   

   

   

   For i = 1 To ParamsCount

      GetValueFromFile()

      ParamNames[i] =  FileValue

      

      GetFigureFromFile()

      ParamValues[i] =FileFigure

   EndFor

    

' The following line could be harmful and has been automatically commented.

'    EV3File.Close(fn3)

     

   EndSub

   

   

   Sub ShowParams

  

  LCD.StopUpdate ()

  

 LCD.Clear()

LCD.Rect(1, 0, 0, 178, 128) 

LCD.Line(1, 130, 0, 130, 128) 

For i = 0 To 9

  If (StartParam + i) <= ParamsCount Then

    LCD.Text (1, 2, 2+(i)*13, 0, ParamNames[StartParam +i]) 

    

    If i = 1 or i = 2 then

      'instead 0 and 1 write yes(1) or no(0)

      If Text.IsSubText(ParamValues[StartParam +i],"1") then

         LCD.Text (1, 132, 2+(i)*13, 1, "Yes")

      Else

         LCD.Text (1, 132, 2+(i)*13, 1, "No")

      EndIf

      

      

    Else

     LCD.Text (1, 132, 2+(i)*13, 1, ParamValues[StartParam +i])

    EndIf

  

    LCD.Line(1, 2, (i+1)*13, 178, (i+1)*13)

  EndIf

  

  

  

  

EndFor

LCD.InverseRect (2, 2+(CurrParam-1)*13, 175, 13) 



LCD.Update ()

EndSub



sub SwitchCurrParam

  'Assert.Failed("currValue:"+CurrParam +":"+ ParamValues[CurrParam] + "-")

  

  If ParamValues[CurrParam] = 1 Then

    ParamValues[CurrParam] = 0

  Else

    ParamValues[CurrParam] = 1

  EndIf

  

EndSub







Sub EditParams

  StartParam = 1

  CurrParam = 1

  ShowParams()

  

  EV3.SetLEDColor ("GREEN", "NORMAL")

  

  Buttons.Wait()

  K=Buttons.GetClicks()

  

  While 1=1

  

  While K <> "L" And K <> "R"

    'Up button

    If K = "U" Then

      CurrParam =CurrParam-1

      If (CurrParam < 1 ) Then

        CurrParam = 1

        If StartParam > 1 Then

           StartParam=StartParam-1

        EndIf

       EndIf

       ShowParams()

    EndIf

    

    'Down button

    If K = "D" Then

      

      If ParamsCount > CurrParam Then

        CurrParam =CurrParam+1

      EndIf

    

      If (CurrParam > 10 ) Then

        CurrParam = 10

        If ParamsCount > (StartParam+9) Then

           StartParam = StartParam+1

        EndIf

       EndIf

       ShowParams()

     EndIf

     

    

    If K = "E" Then

      

      Speaker.Tone(100, 400, 200)

      EV3.SetLEDColor ("RED", "PULSE")

      

      Buttons.Flush()

      Buttons.Wait()

      K=Buttons.GetClicks()

      

      While K <> "E" 

        

        'Up button

        If K = "U" Then

          

          If CurrParam = 1  or CurrParam = 4 then

            ParamValues[CurrParam]=     ParamValues[CurrParam] + 0.1

          Else

            SwitchCurrParam()

          EndIf

       

      ShowParams()

    EndIf

    

    'Down button

    If K  = "D" Then

          If CurrParam = 1  or CurrParam = 4 then

            ParamValues[CurrParam]=     ParamValues[CurrParam] - 0.1

            If ParamValues[CurrParam] <=0 then

              ParamValues[CurrParam] = 0

            EndIf

                       

          Else

            SwitchCurrParam()

          EndIf

       ShowParams()

     EndIf

     

     'Left  button

    If K = "L" Then

       If CurrParam = 1  or CurrParam = 4 then

               ParamValues[CurrParam]=     ParamValues[CurrParam] - 1

            If ParamValues[CurrParam] <=0 then

              ParamValues[CurrParam] = 0

            EndIf

                       

          Else

            SwitchCurrParam()

          EndIf

       ShowParams()

     EndIf

     

     'Right  button

    If K = "R" Then

       If CurrParam = 1  or CurrParam = 4 then

               ParamValues[CurrParam]=     ParamValues[CurrParam] + 1

                       

          Else

            SwitchCurrParam()

          EndIf

       ShowParams()

     EndIf

     

      Buttons.Flush()

      Buttons.Wait()

      K=Buttons.GetClicks()

      

      EndWhile

      

      Speaker.Tone(100, 400, 100)

      EV3.SetLEDColor ("GREEN", "NORMAL")

      SaveSettings()

      

      

      'ReadStringFromLCD()

      'ParamValues[CurrParam] = mytext

      

    

     'SaveSettings()

     'ReadSettings()

      

     'ShowParams()

     EndIf

    

    

   Buttons.Wait()

   K=Buttons.GetClicks()

   

  EndWhile

    'user press enter button

    

    

    

  EndWhile

  

  

  

  EndSub  







Sub ShowGrid

  LCD.Clear()

  LCD.StopUpdate()

  

  LCD.Rect(1,0,0,177,127)

  LCD.Write(5,3,"Lego EV3 tool for IoT")

  RunTime = EV3.Time

  'draw place and names for sensors

  For i = 0 To 3

    LCD.Text(1,i*43+15,18,0, "S"+(i+1))

    LCD.Rect(1,i*43+4,15,40,40)



  EndFor

  

  'draw place and names for motors

  

  For i = 0 To 3

   LCD.Text(1,i*43+15,65,0, "M"+(i+1)) 

   LCD.Rect(1,i*43+4,60,40,40)

   LCD.Text(1,i*43+7,80,0, MotorSpeed[i+1]) 

    

  EndFor  

  

  LCD.Update()

  

  

  'detect sensor type and show it in grid

  For i = 1 To 4

    If SensorType[i] > 0 Then

      LCD.Text(1,(i-1)*43+7,30,0, Text.GetSubText(SensorName[i],1,4))

    Else

      'draw cross, means this sensor not used

      LCD.Line(1,(i-1)*43+4,15,(i-1)*43+43,52)

      LCD.Line(1,(i-1)*43+5,52,(i-1)*43+42,15)

    EndIf

         

      

    

  EndFor

  

  

  'show sensor values until user press ENTER

  Buttons.Flush()

  K = Buttons.Current

  While  (Text.IsSubText(K, "E")) = "False"

    

    

    'show sensor values  if  update on time 

    

      LCD.StopUpdate()

    

   For i = 1 To 4

     

     If SensorType[i] > 0 then

    

     If SensorType[i] = 16 Then

       if Sensor.ReadPercent(i) = 0 then

         SensorValue[i] = 0

       Else

         SensorValue[i] = 1

       EndIf

     ElseIf SensorType[i] = 30 Then

       'ev3 ultrasonic

       SensorValue[i] = Sensor.ReadRawValue(i,0)

       Else

          SensorValue[i] = Sensor.ReadPercent(i)  

     EndIf

     

     LCD.Text(1,(i-1)*43+7,43,1, "    " )

     LCD.Text(1,(i-1)*43+7,43,1, SensorValue[i] )

     endif

  EndFor



   LCD.Text(1,5,115,1,Text.Append("Run time (sec) ",Math.Round((Ev3.Time - RunTime)/1000)) )

   

   LCD.Update()

   

   Program.Delay(250)

   K = Buttons.Current

   

   'withour licence time restricted 60 sec

   If hasLicence = 0 Then

     If Math.Round((Ev3.Time - RunTime)/1000) > 60 then

       StartSend = 0

       LCD.Clear()

       LCD.Text(1,20,20,2,"Demo mode")

       LCD.Text(1,0,60,2,"60 sec only")

       Buttons.Flush()

       Buttons.Wait()

       Buttons.GetClicks()

       

       K = "E"  

     endif

   EndIf

   

   

 EndWhile



   Buttons.Flush()

EndSub 





Sub CheckLinuxProgram



    'get brick number

    EV3.SystemCall("hcitool dev | grep 'hci0' > /home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     fn2 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     FileName = EV3File.ReadLine(fn2)

' The following line could be harmful and has been automatically commented.

'     EV3File.Close(fn2)

    If FileName <> "" Then

      BrickNumber = "a"+Text.GetSubText(FileName,7,2)+ Text.GetSubText(FileName,10,2)+ Text.GetSubText(FileName,13,2)+ Text.GetSubText(FileName,16,2) +  Text.GetSubText(FileName,19,2)+ Text.GetSubText(FileName,22,2)

      BrickNumber = Text.GetSubTextToEnd(BrickNumber,2)  

      

      GetSerialCode()

    Else

      BrickNumber= "unknown"

      SerialCode = "unknown"  

    EndIf

    

    

   'check there is linux program for send ThingWorx post queries

  'If not exist - create it

   EV3.SystemCall("ls /home/root/lms2012/prjs/Send_IOT > /home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     fn2 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     FileName = EV3File.ReadLine(fn2)

' The following line could be harmful and has been automatically commented.

'     EV3File.Close(fn2)

   ' If FileName <> "" Then

      'file exist 

   ' Else

      'file not exist - create it

            

            '1) look for Send_IOT.rtf file 

            EV3.SystemCall("find /home/root/lms2012/prjs/ -name Send_IOT.rtf > /home/root/lms2012/prjs/file.txt")

            

' The following line could be harmful and has been automatically commented.

'             fn3 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'             FileName = EV3File.ReadLine(fn3)

' The following line could be harmful and has been automatically commented.

'             EV3File.Close(fn3)

            If FileName <> "" Then

              'file exit - copy it wih correct name

               EV3.SystemCall("cp " + Filename + " /home/root/lms2012/prjs/Send_IOT")

            Else

              'file not exist - create it

              EV3.SetLEDColor("RED","FLASH")

              LCD.Clear()

              LCD.Text(1,1,18,0, "Not found Send_IOT.rtf")

              Buttons.Flush()

              Buttons.Wait()

              

            EndIf

      

    'EndIf

      

      

      

EndSub





Sub DrawKeyboardPrepare

    LCD.Clear()

  LCD.StopUpdate()

  

  'borders

  LCD.Rect(1,21,5,141,116)

  

  'space

  LCD.Line(1,45,113,117,113)  

  LCD.Line(1,45,106,117,106)

  LCD.Line(1,44,112,44,107)

  LCD.Line(1,118,112,118,107)

  

  ''place for text

  LCD.Line(1,26,56,157,56)  

  LCD.Line(1,26,24,157,24) 

  LCD.Line(1,25,55,25,25)

  LCD.Line(1,158,55,158,25)

  

  'sample text

  LCD.Text(1,27,28,0,"                ")

  LCD.Text(1,27,42,0,"                ")

  

  'sample header

  LCD.Text(1,27,9,0,strQuestion )

  

  'backspace button

  LCD.Line(1,146,63,155,63)

  LCD.Line(1,146,73,155,73)

  LCD.Line(1,145,64,145,72)

  LCD.Line(1,156,64,156,72)

  

  LCD.Line(1,147,68,150,71)

  LCD.Line(1,147,68,150,65)

  

  LCD.Line(1,150,71,150,69)

  LCD.Line(1,150,67,150,65)

  LCD.Line(1,150,69,154,69)

  LCD.Line(1,150,67,154,67)

  

  LCD.Line(1,154,69,154,67)

   

  'Enter button

  LCD.Line(1,135,114,157,114)

  LCD.Line(1,135,114,135,91)

  LCD.Line(1,135,91,144,91)

  LCD.Line(1,144,91,144,76)

  LCD.Line(1,144,76,157,76)

  LCD.Line(1,157,76,157,114)

  

  LCD.Line(1,140,102,140,101)

  LCD.Line(1,141,103,141,101)

  LCD.Line(1,142,104,142,102)

  LCD.Line(1,143,105,143,103)

  LCD.Line(1,144,106,144,104)

  LCD.Line(1,145,106,145,103)

  LCD.Line(1,146,105,146,102)

  LCD.Line(1,147,104,147,101)

  LCD.Line(1,148,103,148,100)

  LCD.Line(1,149,101,149,99)

  LCD.Line(1,150,100,150,98)

  LCD.Line(1,151,99,151,97)

  LCD.Line(1,152,98,152,97)

  LCD.Line(1,153,97,153,97)

EndSub





Sub DrawBigLetters

  

  DrawKeyboardPrepare()

  

  'shiftDown button

  LCD.Line(1,26,87,38,87)

  LCD.Line(1,26,77,38,77)

  LCD.Line(1,25,86,25,78)

  LCD.Line(1,39,86,39,78)

  

  LCD.Line(1,28,82,31,85)

  LCD.Line(1,32,85,35,82)

  LCD.Line(1,33,82,35,82) 

  LCD.Line(1,28,82,30,82) 

  LCD.Line(1,30,82,30,79)

  LCD.Line(1,33,82,33,79)

  LCD.Line(1,30,79,33,79)

  

  'numbers button

  LCD.Line(1,26,101,38,101)

  LCD.Line(1,26,91,38,91)

  LCD.Line(1,25,100,25,92)

  LCD.Line(1,39,100,39,92)

  

  LCD.Line(1,27,99,29,99)

  LCD.Line(1,31,99,33,99)

  LCD.Line(1,35,99,36,99)

  LCD.Line(1,28,98,28,93)

  LCD.Line(1,27,94,28,93)

  LCD.Line(1,31,98,33,96)

  LCD.Line(1,33,96,33,94)

  LCD.Line(1,33,94,32,93)

  LCD.Line(1,31,94,32,93)

  LCD.Line(1,37,98,37,97)

  LCD.Line(1,36,96,37,95)

  LCD.Line(1,37,94,36,93)

  LCD.Line(1,35,93,36,93)

  

  For i = 1 To 10

    LCD.Text(1,21+i*11,64,0,Text.GetSubText(lineUp[1],i,1))

  EndFor

  

  For i = 1 To 9

    LCD.Text(1,32+i*11,78,0,Text.GetSubText(lineUp[2],i,1))

  EndFor

  

  For i = 1 To 7

    LCD.Text(1,32+i*11,92,0,Text.GetSubText(lineUp[3],i,1))

  EndFor



  LCD.Update()

  

  

  Buttons.Flush()

  Buttons.Wait()

  Buttons.GetClicks()

EndSub





Sub GetTextFromKeyboard

  curKeyMode = 0 ' upper case letters

  

EndSub





Sub ShowTasks

  LCD.StopUpdate()

  

  LCD.Clear()

  LCD.Text (1, 2, 2, 1, "Select Project") 

   For i = 0 To 6

     If ((StartTask+i)  <= IoTFileCount) Then

       FileShort = IoTFile[StartTask+i]

       hh = Text.GetLength(FileShort)

       

        While Text.StartsWith(Text.GetSubTextToEnd(FileShort,hh),"/") <> "True"

           hh = hh-1

       EndWhile

       FileShort = Text.GetSubTextToEnd(FileShort,hh+1)

       FileShort = Text.GetSubText(FileShort,1,Text.GetLength(FileShort)-4)      

          LCD.Text (1, 2, 22+i*16, 0, FileShort) 

    EndIf

  EndFor

  

  LCD.InverseRect (2, 20+(CurrTask-1)*16, 175, 14)

  LCD.Update()

EndSub



Sub SelectTask

   'show list of projects and select one 

  StartTask = 1

  CurrTask = 1

  

  ShowTasks()

  EV3.SetLEDColor ("ORANGE", "NORMAL")



  Buttons.Wait()

  K=Buttons.GetClicks()

   

    While  (K <>"E") 

        

    'Up button

    If K =  "U" Then

      CurrTask =CurrTask-1

      If (CurrTask < 1 ) Then

        CurrTask = 1

        If StartTask > 1 Then

           StartTask=StartTask-1

        EndIf

       EndIf

       ShowTasks()

    EndIf

    

    'Down button

    If K=  "D" Then

      

      If IoTFileCount > CurrTask Then

        CurrTask =CurrTask+1

      EndIf

    

      If (CurrTask > 7 ) Then

        CurrTask = 7

        If IoTFileCount > (StartTask+6) Then

           StartTask = StartTask+1

        EndIf

       EndIf

       ShowTasks()

     EndIf

     

    

    Buttons.Wait()

    K=Buttons.GetClicks()

  

  EndWhile

  c = StartTask+CurrTask-1

  'read settings from file 

  

  

  IOT_Server = ""

  IOT_ServiceName = ""

  IOT_AppKey = ""

  IOT_ThingName = ""

  For ww =1 To 4

    SensorType[ww]= 0

    SensorMode[ww]= 0  

    SensorName[ww]= ""

  EndFor

  

  

LCD.Clear()



  isGoodFileFormat  = 0

  MsgText = ""



' The following line could be harmful and has been automatically commented.

'    fn3 = EV3File.OpenRead(IoTFile[c])

' The following line could be harmful and has been automatically commented.

'    FileName = EV3File.ReadLine(fn3)

       If Text.GetLength(FileName) > 0 then

          If Text.GetCharacterCode(Text.GetSubText(FileName,Text.GetLength(FileName),1)) = 13 Then

            'if text finished chr(13), remove it from text

            FileName = Text.GetSubText(FileName,1,Text.GetLength(FileName)-1)

          EndIf

        EndIf

        

   

          While FileName <> ""

            

            If Text.StartsWith(FileName,"Server:") Then

              IOT_Server = Text.GetSubTextToEnd(FileName,8)

            ElseIf Text.StartsWith(FileName,"ServiceName:") Then

              IOT_ServiceName= Text.GetSubTextToEnd(FileName,13)

              

              If Text.GetIndexOf(IOT_ServiceName,"/Services/") > 0 then

                IOT_ThingName = Text.GetSubText(IOT_ServiceName,1,Text.GetIndexOf(IOT_ServiceName,"/Services/"))

                

              Else

                ' cant find /Services in   IOT_ServiceName

                LCD.Text(1,1,isGoodFileFormat*15,1,"Can't find /Services/ in Service string")

                isGoodFileFormat = isGoodFileFormat +1

              EndIf

              

            ElseIf Text.StartsWith(FileName,"AppKey:") Then

              IOT_AppKey = Text.GetSubTextToEnd(FileName,8)

            ElseIf Text.StartsWith(FileName,"S1:") Then

              SensText = Text.GetSubTextToEnd(FileName,4)

              ParseSensText()

              

              SensorName[1] = SensText

              SensorType[1] = SensType

              SensorMode[1] = SensMode

              

     

            ElseIf Text.StartsWith(FileName,"S2:") Then

              SensText = Text.GetSubTextToEnd(FileName,4)

              ParseSensText()

              IOT_S2_Type = SensType

              IOT_S2_Mode = SensMode

              

              SensorName[2] = SensText

              SensorType[2] = SensType

              SensorMode[2] = SensMode

              

            

            ElseIf Text.StartsWith(FileName,"S3:") Then

              SensText = Text.GetSubTextToEnd(FileName,4)

              ParseSensText()

              IOT_S3_Type = SensType

              IOT_S3_Mode = SensMode

              

              SensorName[3] = SensText

              SensorType[3] = SensType

              SensorMode[3] = SensMode

              

              

            ElseIf Text.StartsWith(FileName,"S4:") Then  

              SensText = Text.GetSubTextToEnd(FileName,4)

              ParseSensText()

              IOT_S4_Type = SensType

              IOT_S4_Mode = SensMode

              

              

              SensorName[4] = SensText

              SensorType[4] = SensType

              SensorMode[4] = SensMode

              

              

            EndIf

            

            

                       

' The following line could be harmful and has been automatically commented.

'         FileName = EV3File.ReadLine(fn3)

                       

        If Text.GetLength(FileName) > 0 then

          If Text.GetCharacterCode(Text.GetSubText(FileName,Text.GetLength(FileName),1)) = 13 Then

            'if text finished chr(13), remove it from text

            FileName = Text.GetSubText(FileName,1,Text.GetLength(FileName)-1)

          EndIf

        EndIf

        

          EndWhile



' The following line could be harmful and has been automatically commented.

'    EV3File.Close(fn3)

   

   

   

      'check is file filled correct or not

      If IOT_Server = "" Then

        LCD.Text(1,1,isGoodFileFormat*15,1,"not set Server:")

        isGoodFileFormat = isGoodFileFormat +1

      EndIf

      

      If IOT_ServiceName = "" Then

        LCD.Text(1,1,isGoodFileFormat*15,1,"not set Service name:")

        isGoodFileFormat = isGoodFileFormat +1

      EndIf

      

      If IOT_AppKey= "" Then

        LCD.Text(1,1,isGoodFileFormat*15,1,"not set AppKey:")

        isGoodFileFormat = isGoodFileFormat +1

      EndIf

   

       For ww = 1 To 4   

      

              If SensorType[ww]  < 0  Then

              LCD.Text(1,1,isGoodFileFormat*15,1,"Incorrect S"+ ww + " Type")

              isGoodFileFormat = isGoodFileFormat +1

              Else

                'check is this sensor connected to this port or not

                If SensorType[ww] > 0 then

                If Sensor.GetType(ww) = SensorType[ww] Then

                 'Set port mode

                 Sensor.SetMode(ww,SensorMode[ww])

                Else

                  ' incorrect Sensor 

                  LCD.Text(1,1,isGoodFileFormat*15,1,"S" + ww + " should be: " + SensorName[ww])

                  isGoodFileFormat = isGoodFileFormat +1

                EndIf

                endif

               EndIf

         EndFor

         

      

      If isGoodFileFormat <> 0 then

        Buttons.Flush()

        Buttons.Wait()

        Buttons.GetClicks()

      EndIf

      

        

     

     

    

EndSub



Sub ParseSensText

  SensText = text.ConvertToUpperCase(SensText)

  

  

  If text.IsSubText(SensText,"NONE") Then

    SensType = 0

    SensMode = 0 

  ElseIf text.IsSubText(SensText,"TOUCH")  Then

    SensType = 16

    SensMode = 0 

  ElseIf text.IsSubText(SensText,"COL-REFLECT")  Then

    SensType = 29

    SensMode = 0 

  ElseIf text.IsSubText(SensText,"COL-AMBIENT") Then

    SensType = 29

    SensMode = 1 

  ElseIf text.IsSubText(SensText,"COL-COLOR")  Then

    SensType = 29

    SensMode = 2   

  ElseIf text.IsSubText(SensText,"US-DIST-CM")  Then

    SensType = 30

    SensMode = 0 

  ElseIf text.IsSubText(SensText,"US-DIST-IN") Then

    SensType = 30

    SensMode = 1  

  ElseIf text.IsSubText(SensText,"GYRO-ANG")   Then

    SensType = 32

    SensMode = 0  

  ElseIf text.IsSubText(SensText,"GYRO-RATE")   Then

    SensType = 32

    SensMode = 1  

  ElseIf text.IsSubText(SensText,"IR-PROX")  Then

    SensType = 33

    SensMode = 0  

          

  Else

    SensType = -1 ' not defined

    SensMode = 0

  EndIf

  

EndSub







LCD.Clear()



CheckWiFiConnected()

CheckLinuxProgram()

CheckLicence()



ReadSettings()



'DrawBigLetters()





'ShowGrid()



While SelectedProject <> "Exit"

  SelectMenuItem()

  

  If SelectedProject = PrjList[1] Then

    

    GetListOfTasks()

       

    'if no files - show message about it

    If IoTFileCount > 0 Then

      SelectTask()

      If isGoodFileFormat = 0 then

        StartSend = 1

        SendCount = 0

        'start thread for send data to server

        Thread.Run = SendDataToServer

        

        'start thread for read data from server

        Thread.Run = ReadDataFromServer

        Buttons.Flush()

        

        

      Program.Delay(500)

      ShowGrid()

      StartSend = 0

      Program.Delay(200)

      Motor.Stop("ABCD","TRUE")

      ShowMenuItems()

      EndIf

     Else

              EV3.SetLEDColor("RED","FLASH")

              LCD.Clear()

              LCD.Text(1,1,18,0, "Not found .iot files")

              Buttons.Flush()

              Buttons.Wait()

              Buttons.GetClicks()

     endif

     

   ElseIf SelectedProject = PrjList[2] Then

     EditParams()     

   ElseIf SelectedProject = PrjList[3] Then

     AboutBox()

     

  EndIf

  

EndWhile

  

'Buttons.Flush()

'Buttons.Wait()



Sub GetListOfTasks

  ' get lis of *.iot files

   EV3.SystemCall("find /home/root/lms2012/prjs/ -name *.iot > /home/root/lms2012/prjs/file.txt")

            

' The following line could be harmful and has been automatically commented.

'             fn3 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'             FileName = EV3File.ReadLine(fn3)

            IoTFileCount = 0

          While FileName <> ""

           

            IoTFileCount =IoTFileCount+1

            IoTFile[IoTFileCount] = FileName

            

' The following line could be harmful and has been automatically commented.

'             FileName = EV3File.ReadLine(fn3)

           

          EndWhile



' The following line could be harmful and has been automatically commented.

'      EV3File.Close(fn3)

     

EndSub





Sub CheckWiFiConnected

  

  WiFiConnected = 0

  EV3.SystemCall("ip addr show | grep 'wlan0' > /home/root/lms2012/prjs/file.txt")

  

' The following line could be harmful and has been automatically commented.

'   fn3 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'             FileName = EV3File.ReadLine(fn3)

' The following line could be harmful and has been automatically commented.

'             EV3File.Close(fn3)

            

            

            If FileName <> "" Then

              'WiFi turned on and connected 

              'Assert.Failed(FileName)

              

              'check is WiFi up

              If Text.IsSubText(Text.ConvertToUpperCase(FileName),"STATE UP") Then

                WiFiConnected = 1

              EndIf

              

              

  

            EndIf

            

            

            If WiFiConnected = 0 Then

              'WiFi is not connected

              EV3.SetLEDColor("RED","FLASH")

              LCD.Clear()

              LCD.Text(1,1,18,0, "WiFi is not connected")

              LCD.Text(1,18,40,0, "setup it correct")

              LCD.Text(1,1,60,0, "and run program again")

              

              Buttons.Flush()

              Buttons.Wait()

              Buttons.GetClicks()

              Buttons.Flush()

              

              Endif

              

              

EndSub



Sub ReadDataFromServer

  

  While StartSend = 1

    

    delayRead = ParamValues[4]*1000

    If delayRead = 0 Then 

      delayRead = 100

    EndIf

      

    Program.Delay(delayRead )

      

    'Assert.Failed("/home/root/lms2012/prjs/Send_IOT " + IOT_Server + " "  + IOT_AppKey  + " " + IOT_ThingName+"Properties" + " " + "GET 0 0 0" )

    EV3.SystemCall("/home/root/lms2012/prjs/Send_IOT " + IOT_Server + " "  + IOT_AppKey  + " " + IOT_ThingName+"Properties" + " " + "GET 0 0 0" )

    Program.Delay(200)

    

    'now look for result file with answer

    EV3.SystemCall("ls " + strAnswerFile +"> /home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     fn2 = EV3File.OpenRead("/home/root/lms2012/prjs/file.txt")

' The following line could be harmful and has been automatically commented.

'     FileName = EV3File.ReadLine(fn2)

' The following line could be harmful and has been automatically commented.

'     EV3File.Close(fn2)

    If FileName <> "" Then

      'file exist

     

' The following line could be harmful and has been automatically commented.

'      fn3 = EV3File.OpenRead(strAnswerFile)

     answText = ""

     ReadedBytes = 0

     

' The following line could be harmful and has been automatically commented.

'      CharRead = EV3File.ReadByte(fn3)

     While (CharRead <> 13 And CharRead <> 0 )

       ReadedBytes = ReadedBytes +1

       If ReadedBytes > 7 Then

         For gg = 1 To 6

           ReadFileV[gg] = ReadFileV[gg+1]

         EndFor

         ReadFileV[7] = Text.GetCharacter(CharRead)

         

         subanswText =""

         For gg = 1 To 7

           subanswText  = text.Append(subanswText ,ReadFileV[gg]) 

         EndFor

         

         Assert.Failed(subanswText)

         If Text.ConvertToUpperCase(subanswText) = "M1SPEED" then

           Assert.Failed("Found")

         EndIf

         

       Else

         ReadFileV[ReadedBytes] = Text.GetCharacter(CharRead)

       EndIf

       

       answText=Text.Append(answText,Text.GetCharacter(CharRead))

' The following line could be harmful and has been automatically commented.

'        CharRead = EV3File.ReadByte(fn3)

      EndWhile



' The following line could be harmful and has been automatically commented.

'            EV3File.Close(fn3)

          

             Assert.Failed(Text.GetLength(answText))  

            If answText <> "" Then

              'look for M1Speed,M2Speed,M2Speed,M2Speed values 

              For ms = 1 To 4

                If Text.IsSubText(answText,"M"+ms+"Speed") Then

                  subanswText  = Text.GetSubTextToEnd(answText,Text.GetIndexOf(answText,"M"+ms+"Speed")+16)

                  subanswText = Text.GetSubText(subanswText,1,Text.GetIndexOf(subanswText,".")-1)

' The following line could be harmful and has been automatically commented.

'                   'Assert.Failed(EV3File.ConvertToNumber(subanswText))

                  

' The following line could be harmful and has been automatically commented.

'                   MotorSpeed[ms] = EV3File.ConvertToNumber(subanswText)

                  

                  If ms = 1 then

                    If MotorSpeed[ms] <>0 then

                      Motor.Start("A",MotorSpeed[ms])

                    Else

                      Motor.Stop ("A","True")

                    EndIf

                  

                    

                  ElseIf ms = 2 then

                    If MotorSpeed[ms] <>0 then

                      Motor.Start("B",MotorSpeed[ms])

                    Else

                      Motor.Stop ("B","True")

                    EndIf

                                      

                  ElseIf ms = 3 then

                    

                    If MotorSpeed[ms] <>0 then

                      Motor.Start("C",MotorSpeed[ms])

                    Else

                      Motor.Stop ("C","True")

                    EndIf

                                      

                  ElseIf ms = 4 then

                  If MotorSpeed[ms] <>0 then

                      Motor.Start("D",MotorSpeed[ms])

                    Else

                      Motor.Stop ("D","True")

                    EndIf

                                      

                  endif

                  

                  'show this values on the screen

                  LCD.Text(1,(ms-1)*43+7,80,0, "    ") 

                  LCD.Text(1,(ms-1)*43+7,80,0, MotorSpeed[ms]) 

   

                endif

              EndFor

        

            endif

            

    EndIf

    

    

  EndWhile

   Motor.Stop("ABCD","TRUE")

   ShowMenuItems()

  

EndSub





Sub SendDataToServer

  SensorChanged  = 1

  

  While StartSend = 1

    

    delay = ParamValues[1]*1000

    If delay = 0 Then

      'wait until any sensor value changes

      'Assert.Failed("0")

      

      While SensorChanged <>1

        For h = 1 To 4

          If SensorType[h] >0 then

            

            

          If SensorValue[h] <> OldSensorValue[h] then

            SensorChanged = 1

            OldSensorValue[h] = SensorValue[h]

        

          EndIf

          endif

        EndFor

        

      EndWhile

      delay = 100

      EndIf

      

      

      If ParamValues[2] = 1 Then

        'beep on send

        Speaker.Tone(100,1500,50)

        delay = delay -50

      EndIf

    

      If ParamValues[3] = 1 Then

        'blink on send

        LCD.InverseRect(1,100,178, 27) 

        Program.Delay(50)

        LCD.InverseRect(1,100,178, 27) 

        delay = delay -50

      EndIf

    

    Program.Delay(delay)

      

        

    'Run tool for send data to ThingWorx server

    strParam1 = "/home/root/lms2012/prjs/Send_IOT"

    strParam1 = Text.Append(strParam1," "+IOT_Server )

    strParam2 = " "+IOT_AppKey

    strParam3 = " "+IOT_ServiceName

    

    strParam4 ="" 

    For i = 1 To 4

      If i >1 Then

        strParam4 = Text.Append(strParam4 ," ")

        

      EndIf

      

      If SensorType[i] >0 Then

        strParam4 = Text.Append(strParam4 ,"S"+i+"=")

        strParam4 = Text.Append(strParam4 ,SensorValue[i])

       Else

        'send 0 for not set sensors

        strParam4 = Text.Append(strParam4 ,"S"+i+"=0")



      EndIf

      

        

         

    EndFor 

    

    'strParam1 = Text.Append(strParam1," "+strParam2)

    

    'Assert.Failed("/home/root/lms2012/prjs/Send_IOT " + IOT_Server + " "  + IOT_AppKey  + " " + IOT_ServiceName + " " + strParam4)

    

    EV3.SystemCall("/home/root/lms2012/prjs/Send_IOT " + IOT_Server + " "  + IOT_AppKey  + " " + IOT_ServiceName + " " + strParam4 )

    

    SendCount = SendCount + 1

    LCD.Text(1,5,103,1,"Send count:" + SendCount)

    SensorChanged  = 0

  EndWhile

   ShowMenuItems()

  

EndSub  


