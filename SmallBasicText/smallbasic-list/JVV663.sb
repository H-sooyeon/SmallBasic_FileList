'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

'Если игра тормозит, попробуйте уменьшить значение переменной (это основная), вплоть до нуля, можно ставить дробные значения : 
pDelay=3

'Еще задержка при поворотах (на ноль не ставить):
tDelay = 3

'Ну и самое действенное, уменьшить количество противников, минимальное значение 1, м��ксимальное 3. Уменьшением значения это переменной можно 
'добиться увеличения производительности игры в несколько раз:
enemies_number = 3





'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





version="r"





'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'/////////////////////////////////////////////////////////////////Функции инициализации программы///////////////////////////////////////////////////////////
'/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


declare()       'Объявление некоторых переменных
data_file()     'Файл с данными игры
map_borders()   'Границы карт
gen_enem()      'Генерация врагов
init_dl()       'Окно загрузки
download()      'Скачивание всех картинок
init_mm()       'Окно главного ��еню
game()          'Сама игра





Sub declare
  'Откуда все качается
  dir = "http://dl.dropbox.com/u/1808855/the_death_race/" 
  'dir = "C:\Users\rayevg\Documents\My Dropbox\Public\the_death_race\" 
  'Жизни машин
  hp[1]=100
  hp[2]=100
  hp[3]=100
  hp[4]=100
  
  '"Пробная пуля"
  tb = Shapes.AddRectangle(0,0) 
  Shapes.Move(tb,500,500)
  
  'Начальные значения некоторых переменных
  write_position =1
  pcar=1
  map=1
  diff=2
  can_fire = 0
  
  'Время записи старых координат машины
  car_coor_time[1][1]=-1
  car_coor_time[2][1]=-1
  car_coor_time[3][1]=-1
  car_coor_time[4][1]=-1
  
  'Скорости машин
  car_speed[1]=0
  car_speed[2]=0
  car_speed[3]=0
  car_speed[4]=0
  
  'Углы поворота машин
  car_angle[1]=0
  car_angle[2]=0
  car_angle[3]=0
  car_angle[4]=0
  
  'Жива ли машина
  car_alive[1]=1
  car_alive[2]=1
  car_alive[3]=1
  car_alive[4]=1
  
  
  'Время простоя машины в запрещенной зоне
  car_forr_time[1][1]=-1
  car_forr_time[2][1]=-1
  car_forr_time[3][1]=-1
  car_forr_time[4][1]=-1
  
  'Финишировала ли машина
  car_finished[1]=0 
  car_finished[2]=0 
  car_finished[3]=0 
  car_finished[4]=0 
  
  'Количество летящих (задействованных) пуль и ракет
  ammo_b_cnt=0
  ammo_r_cnt=0
  
  'Просто переменная, сбрасывается на 1 каждые 100 мс
  br=1
  
  'Количество  пуль в з��пасе у машин
  ammo_bullets_counter[1]=100
  ammo_bullets_counter[2]=100
  ammo_bullets_counter[3]=100
  ammo_bullets_counter[4]=100
  
  'Количество  ракет в запасе у машин
  ammo_rockets_counter[1]=2
  ammo_rockets_counter[2]=2
  ammo_rockets_counter[3]=2
  ammo_rockets_counter[4]=2
  
  'Время перезарядки пуль
  ammo_time_b[1][1]=-1
  ammo_time_b[2][1]=-1
  ammo_time_b[3][1]=-1
  ammo_time_b[4][1]=-1
  
  'Время перезарядки ракет
  ammo_time_r[1][1]=-1
  ammo_time_r[2][1]=-1
  ammo_time_r[3][1]=-1
  ammo_time_r[4][1]=-1
  
  'Время прицеливания
  target_rocket[1][1]=-1
  target_rocket[1][2]=-1
  target_rocket[1][3]=-1
  target_rocket[1][4]=-1
  
  'Нанесеный урон
  
  damage=-1
  
  
  'Но��ера машин которын нельзя использовать
  fcar1=500
  fcar2=500
  
  'Старт гонки
  already_play = 0
  race_start[1]=-1
  
  laps[1] = -1
  laps[2] = -1
  laps[3] = -1
  laps[4] = -1
  
  For i=1 to 4
    cpl[i][1]=0      'Пред. чекпоинт
    cpl[i][2]=0
    cpl[i][3]=0
  EndFor
  
  For i=1 to 51 
    For j=1 to 4
      cps[i][j]=0  'Время на каждом чекпоинте
    EndFor
  EndFor
  
  
  
endsub



Sub data_file
  df="C:\death_race_data.dr"
' The following line could be harmful and has been automatically commented.
'   check_str = File.ReadLine(df,1)
  If (check_str="") then
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,1,"This is Death Race data file, do not edit!")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,2,"Data:")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,3,"Player")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,4,"Up")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,5,"Down")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,6,"Left")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,7,"Right")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,8,"Z")
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,9,"X")
    For cnt=10 To 42 
' The following line could be harmful and has been automatically commented.
'       File.WriteLine(df,cnt,"-")
    EndFor
  EndIf
' The following line could be harmful and has been automatically commented.
'   playerName = File.ReadLine(df,3)  
' The following line could be harmful and has been automatically commented.
'   upKey = File.ReadLine(df,4)  
' The following line could be harmful and has been automatically commented.
'   downKey = File.ReadLine(df,5)  
' The following line could be harmful and has been automatically commented.
'   leftKey = File.ReadLine(df,6)  
' The following line could be harmful and has been automatically commented.
'   rightKey = File.ReadLine(df,7)  
' The following line could be harmful and has been automatically commented.
'   bulletsKey = File.ReadLine(df,8)  
' The following line could be harmful and has been automatically commented.
'   rocketsKey = File.ReadLine(df,9)  
  j=1
  For cnt=10 To 42 Step 3
' The following line could be harmful and has been automatically commented.
'     highscore[j][1] = File.ReadLine(df,cnt)    'Имя
' The following line could be harmful and has been automatically commented.
'     highscore[j][2] = File.ReadLine(df,cnt+1)  'Время 
' The following line could be harmful and has been automatically commented.
'     highscore[j][3] = File.ReadLine(df,cnt+2)  'Урон
    j=j+1
  EndFor
  
  
EndSub


Sub download
  
  w1_small_i = ImageList.LoadImage(dir + "w1_small.jpg")
  w2_small_i = ImageList.LoadImage(dir + "w2_small.jpg")
  w3_small_i = ImageList.LoadImage(dir + "w3_small.jpg")
  
  
  car1_i = ImageList.LoadImage(dir + "car1.jpg")
  car2_i = ImageList.LoadImage(dir + "car2.jpg")
  car3_i = ImageList.LoadImage(dir + "car3.jpg")
  car4_i = ImageList.LoadImage(dir + "car4.jpg")
  dead_car_i = ImageList.LoadImage(dir + "dead_car.jpg")
  
  w1_i = ImageList.LoadImage(dir + "w1.jpg")
  w2_i = ImageList.LoadImage(dir + "w2.jpg")
  w3_i = ImageList.LoadImage(dir + "w3.jpg")
  
  set_i = ImageList.LoadImage(dir + "settings.jpg")
  mmenu_i = ImageList.LoadImage(dir + "mmenu.jpg")
  
EndSub

Sub init_dl 
  GraphicsWindow.Width = 1024
  GraphicsWindow.Height = 768 
  
  GraphicsWindow.Title = "Death race"
  
  GraphicsWindow.CanResize = 0
  GraphicsWindow.FontSize = 20
  GraphicsWindow.DrawText(455,350,"Загрузка...")  
  GraphicsWindow.Show()
  
  GraphicsWindow.BrushColor = "black"
EndSub


Sub init_mm
  isplay = 0
  draw_mm()
  GraphicsWindow.MouseDown = click_mm
  
EndSub


Sub click_mm
  For g=1 to 5
    If (GraphicsWindow.MouseX>159) And (GraphicsWindow.MouseX<486) And (GraphicsWindow.MouseY>mm_coors[g]) And (GraphicsWindow.MouseY<mm_coors[g]+61) Then
      If (g=1) then
        init_race_set()
      ElseIf (g=2) then
        init_settings()
      ElseIf (g=3) then
        init_highscore()
      ElseIf (g=4) then
        init_help()
      ElseIf (g=5) then
        Program.End()
      EndIf
    EndIf
  EndFor
EndSub


Sub draw_mm
  GraphicsWindow.FontBold=1
  GraphicsWindow.Clear()
  GraphicsWindow.DrawImage(mmenu_i,0,0)
  GraphicsWindow.FontSize = 28
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.FillRectangle(142,47,362,353)
  
  GraphicsWindow.BrushColor = "SkyBlue"
  GraphicsWindow.PenColor = "black"
  g=0
  For my=70 to 350 step 65
    g=g+1
    GraphicsWindow.FillRectangle(160,my,325,50)
    GraphicsWindow.DrawLine(159,my-1,486,my-1)
    GraphicsWindow.DrawLine(486,my-1,486,my+51)
    GraphicsWindow.DrawLine(486,my+51,159,my+51)
    GraphicsWindow.DrawLine(159,my+51,159,my-1)
    mm_coors[g] = my
    
  EndFor
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(240,mm_coors[1]+7,"Начать гонку")
  GraphicsWindow.DrawText(250,mm_coors[2]+7,"Настройки")
  GraphicsWindow.DrawText(260,mm_coors[3]+7,"Рекорды")
  GraphicsWindow.DrawText(262,mm_coors[4]+7,"Помощь")
  GraphicsWindow.DrawText(273,mm_coors[5]+7,"Выход")
EndSub


Sub init_settings
  made_set = 0
  draw_settings()
  GraphicsWindow.MouseDown = settings_click
  
EndSub

Sub draw_settings
  GraphicsWindow.Clear()
  GraphicsWindow.DrawImage(mmenu_i,0,0)
  GraphicsWindow.FontSize = 28
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.FillRectangle(142,47,362,353)
  
  GraphicsWindow.BrushColor = "SkyBlue"
  GraphicsWindow.PenColor = "black"
  
  
  
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.PenColor = "Black"
  GraphicsWindow.FillRectangle(150,420,100,40)
  GraphicsWindow.DrawLine(150,420,250,420)
  GraphicsWindow.DrawLine(250,420,250,460)
  GraphicsWindow.DrawLine(250,460,150,460)
  GraphicsWindow.DrawLine(150,460,150,420)
  GraphicsWindow.FontSize = 32
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(155,420,"Назад")
  
  GraphicsWindow.BrushColor = "Tomato"
  GraphicsWindow.FillRectangle(395,420,100,40)
  GraphicsWindow.DrawLine(395,420,495,420)
  GraphicsWindow.DrawLine(495,420,495,460)
  GraphicsWindow.DrawLine(495,460,395,460)
  GraphicsWindow.DrawLine(395,460,395,420)
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(425,420,"ОК")
  '///////////////////////////////////////////////////Ввод
  GraphicsWindow.FontSize = 24
  GraphicsWindow.BrushColor = "white"
  GraphicsWindow.FillRectangle(160,90,325,30)
  GraphicsWindow.DrawText(260,50,"Ваше имя:")
  GraphicsWindow.DrawText(250,130,"Управление:")
  GraphicsWindow.BrushColor = "black"
  GraphicsWindow.DrawLine(159,89,486,89)
  GraphicsWindow.DrawLine(486,89,486,121)
  GraphicsWindow.DrawLine(486,121,159,121)
  GraphicsWindow.DrawLine(159,121,159,89)
  
  GraphicsWindow.DrawText(160,90,playerName)
  
  GraphicsWindow.FontSize = 20
  
  GraphicsWindow.BrushColor = "white"
  sy=170
  GraphicsWindow.DrawText(160,sy,      "Вперед                    - ")
  GraphicsWindow.DrawText(160,sy+35,   "Назад                      -")
  GraphicsWindow.DrawText(160,sy+70,   "Влево                      - ")
  GraphicsWindow.DrawText(160,sy+105,  "Вправо                    - ")
  GraphicsWindow.DrawText(160,sy+140,  "Стрелять пулями     - ")
  GraphicsWindow.DrawText(160,sy+175,  "Стрелять ракетами  - ")
  
  
  GraphicsWindow.FillRectangle(385,sy,100,25)
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.DrawLine(384,sy-1,486,sy-1)
  GraphicsWindow.DrawLine(486,sy-1,486,sy+26)
  GraphicsWindow.DrawLine(486,sy+26,384,sy+26)
  GraphicsWindow.DrawLine(384,sy+26,384,sy-1)
  GraphicsWindow.DrawText(385,sy,upKey)
  
  GraphicsWindow.BrushColor = "white"
  GraphicsWindow.FillRectangle(385,sy+35,100,25)
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.DrawLine(384,sy-1+35,486,sy-1+35)
  GraphicsWindow.DrawLine(486,sy-1+35,486,sy+26+35)
  GraphicsWindow.DrawLine(486,sy+26+35,384,sy+26+35)
  GraphicsWindow.DrawLine(384,sy+26+35,384,sy-1+35)
  GraphicsWindow.DrawText(385,sy+35,downKey)
  
  GraphicsWindow.BrushColor = "white"
  GraphicsWindow.FillRectangle(385,sy+70,100,25)
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.DrawLine(384,sy-1+70,486,sy-1+70)
  GraphicsWindow.DrawLine(486,sy-1+70,486,sy+26+70)
  GraphicsWindow.DrawLine(486,sy+26+70,384,sy+26+70)
  GraphicsWindow.DrawLine(384,sy+26+70,384,sy-1+70)
  GraphicsWindow.DrawText(385,sy+70,leftKey)
  
  GraphicsWindow.BrushColor = "white"
  GraphicsWindow.FillRectangle(385,sy+105,100,25)
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.DrawLine(384,sy-1+105,486,sy-1+105)
  GraphicsWindow.DrawLine(486,sy-1+105,486,sy+26+105)
  GraphicsWindow.DrawLine(486,sy+26+105,384,sy+26+105)
  GraphicsWindow.DrawLine(384,sy+26+105,384,sy-1+105)
  GraphicsWindow.DrawText(385,sy+105,rightKey)
  
  GraphicsWindow.BrushColor = "white"
  GraphicsWindow.FillRectangle(385,sy+140,100,25)
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.DrawLine(384,sy-1+140,486,sy-1+140)
  GraphicsWindow.DrawLine(486,sy-1+140,486,sy+26+140)
  GraphicsWindow.DrawLine(486,sy+26+140,384,sy+26+140)
  GraphicsWindow.DrawLine(384,sy+26+140,384,sy-1+140)
  GraphicsWindow.DrawText(385,sy+140,bulletsKey)
  
  
  GraphicsWindow.BrushColor = "white"
  GraphicsWindow.FillRectangle(385,sy+175,100,25)
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.DrawLine(384,sy-1+175,486,sy-1+175)
  GraphicsWindow.DrawLine(486,sy-1+175,486,sy+26+175)
  GraphicsWindow.DrawLine(486,sy+26+175,384,sy+26+175)
  GraphicsWindow.DrawLine(384,sy+26+175,384,sy-1+175)
  GraphicsWindow.DrawText(385,sy+175,rocketsKey)
  
  
  
EndSub




Sub settings_click
  If (GraphicsWindow.MouseX>160) And (GraphicsWindow.MouseX<485) And (GraphicsWindow.MouseY>90) And (GraphicsWindow.MouseY<120) then
    text_enter()
    te_str = playerName
    text_enter_init()
    
  ElseIf (GraphicsWindow.MouseX>150) And (GraphicsWindow.MouseX<250) And (GraphicsWindow.MouseY>420) And (GraphicsWindow.MouseY<460) then
    If (made_set=1) then
      init_mm()
      GraphicsWindow.ShowMessage("Необходимо перезапустить игру!","Важно")
    else
      init_mm()
    Endif
    
  ElseIf (GraphicsWindow.MouseX>385) And (GraphicsWindow.MouseX<485) And (GraphicsWindow.MouseY>sy) And (GraphicsWindow.MouseY<sy+25) then
    made_set=1
    init_up_ent()
    
  ElseIf (GraphicsWindow.MouseX>385) And (GraphicsWindow.MouseX<485) And (GraphicsWindow.MouseY>sy+35) And (GraphicsWindow.MouseY<sy+25+35) then
    made_set=1
    init_down_ent()  
    
  ElseIf (GraphicsWindow.MouseX>385) And (GraphicsWindow.MouseX<485) And (GraphicsWindow.MouseY>sy+70) And (GraphicsWindow.MouseY<sy+25+70) then
    made_set=1
    init_left_ent()  
    
  ElseIf (GraphicsWindow.MouseX>385) And (GraphicsWindow.MouseX<485) And (GraphicsWindow.MouseY>sy+105) And (GraphicsWindow.MouseY<sy+25+105) then
    made_set=1
    init_right_ent()   
    
  ElseIf (GraphicsWindow.MouseX>385) And (GraphicsWindow.MouseX<485) And (GraphicsWindow.MouseY>sy+140) And (GraphicsWindow.MouseY<sy+25+140) then
    made_set=1
    init_bullets_ent() 
    
  ElseIf (GraphicsWindow.MouseX>385) And (GraphicsWindow.MouseX<485) And (GraphicsWindow.MouseY>sy+175) And (GraphicsWindow.MouseY<sy+25+175) then
    made_set=1
    init_rockets_ent()  
    
  ElseIf (GraphicsWindow.MouseX>395) And (GraphicsWindow.MouseX<495) And (GraphicsWindow.MouseY>420) And (GraphicsWindow.MouseY<460) then
    If (te_str<>"") then
      playerName = te_str
    EndIf
    If (upKey_ent<>"") then
      upKey = upKey_ent
    EndIf
    If (downKey_ent<>"") then
      downKey = downKey_ent
    EndIf
    If (leftKey_ent<>"") then
      leftKey = leftKey_ent
    EndIf
    If (rightKey_ent<>"") then
      rightKey = rightKey_ent
    EndIf
    If (bulletsKey_ent<>"") then
      bulletsKey = bulletsKey_ent
    EndIf
    If (rocketsKey_ent<>"") then
      rocketsKey = rocketsKey_ent
    EndIf
    
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,3,playerName)
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,4,upKey)
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,5,downKey)
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,6,leftKey)
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,7,rightKey)
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,8,bulletsKey)
' The following line could be harmful and has been automatically commented.
'     File.WriteLine(df,9,rocketsKey)
    
    GraphicsWindow.ShowMessage("Необходимо перезапустить игру!","Важно")
    init_mm()
    
  EndIf
  
EndSub









Sub init_highscore
  draw_highscore()
  GraphicsWindow.MouseDown = click_help
  
EndSub

Sub draw_highscore
  GraphicsWindow.Clear()
  GraphicsWindow.DrawImage(mmenu_i,0,0)
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.FillRectangle(142,47,362,353)
  
  GraphicsWindow.PenColor = "Black"
  GraphicsWindow.FillRectangle(150,420,100,40)
  GraphicsWindow.DrawLine(150,420,250,420)
  GraphicsWindow.DrawLine(250,420,250,460)
  GraphicsWindow.DrawLine(250,460,150,460)
  GraphicsWindow.DrawLine(150,460,150,420)
  GraphicsWindow.FontSize = 32
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(155,420,"Назад")
  
  '//////////////////////////////////////////////////////Таблица
  GraphicsWindow.FontSize = 20
  GraphicsWindow.BrushColor = "white"
  t_pos = 60
  GraphicsWindow.DrawText(210,t_pos, "Рекорды игры Death Race")
  t_pos = t_pos + 18
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "Имя")
  GraphicsWindow.DrawText(300,t_pos, "Время")
  GraphicsWindow.DrawText(430,t_pos, "Урон")
  t_pos = t_pos + 26
  GraphicsWindow.FontSize = 22
  For cnt=1 to 10 
    GraphicsWindow.DrawText(150,t_pos, highscore[cnt][1])
    GraphicsWindow.DrawText(300,t_pos, highscore[cnt][2])
    GraphicsWindow.DrawText(430,t_pos, highscore[cnt][3])
    t_pos = t_pos + 26
  EndFor
  
EndSub


Sub init_help
  draw_help()
  GraphicsWindow.MouseDown = click_help
  
EndSub

Sub draw_help
  GraphicsWindow.Clear()
  GraphicsWindow.DrawImage(mmenu_i,0,0)
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.FillRectangle(142,47,362,353)
  
  
  GraphicsWindow.PenColor = "Black"
  GraphicsWindow.FillRectangle(150,420,100,40)
  GraphicsWindow.DrawLine(150,420,250,420)
  GraphicsWindow.DrawLine(250,420,250,460)
  GraphicsWindow.DrawLine(250,460,150,460)
  GraphicsWindow.DrawLine(150,460,150,420)
  GraphicsWindow.FontSize = 32
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(155,420,"Назад")
  
  '///////////////////////////////////////////////////////Текст
  GraphicsWindow.FontSize = 18
  GraphicsWindow.BrushColor = "white"
  t_pos = 50
  GraphicsWindow.DrawText(210,t_pos, "Помощь по игре Death Race")
  t_pos = t_pos + 25
  GraphicsWindow.DrawText(150,t_pos, "Правила игры:")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "Ваша задача приехать первым к финишу,")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "причинив, при этом, наибольший урон")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "соперникам.")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "Оружие выдается со второго круга гонки.")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "Если полоска жизней у врага красная,")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "значит он финишировал.")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "Рекорды - это отношению урона к")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "времени, рекорды не зависят от трассы.")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "Настройки:")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "Перед гонкой можно выбрать параметры:")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "автомобиль, трассу, сложность. Чтобы ")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "настроить параметры в меню настроек,")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "нужно кликнуть мышкой по нужному ")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "полю и ввести их с клавиатуры,")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "пробел использоват�� нельзя, он")
  t_pos = t_pos + 18
  GraphicsWindow.DrawText(150,t_pos, "зарезервирован под действие паузы.")
EndSub

Sub click_help
  If (GraphicsWindow.MouseX>150) And (GraphicsWindow.MouseX<250) And (GraphicsWindow.MouseY>420) And (GraphicsWindow.MouseY<460) then
    init_mm()
  EndIf
EndSub






Sub init_race_set
  draw_race_set()
  declare()
  GraphicsWindow.MouseDown = click_race_set
  
EndSub


Sub draw_race_set
  map = 1
  pcar = 1
  diff = 2
  
  
  
  GraphicsWindow.Clear() 
  GraphicsWindow.PenWidth = 1
  GraphicsWindow.DrawImage(set_i,0,0)
  GraphicsWindow.FontSize = 16
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.FillRectangle(282,322,366,350)
  '/////////////////////////////Автомобили
  GraphicsWindow.BrushColor = "SkyBlue"
  GraphicsWindow.FillRectangle(295,335,340,110)
  GraphicsWindow.PenColor = "black"
  
  GraphicsWindow.DrawLine(294,334,636,334)
  GraphicsWindow.DrawLine(636,334,636,446)
  GraphicsWindow.DrawLine(636,446,294,446)
  GraphicsWindow.DrawLine(294,446,294,334)
  
  cs_x=325
  cs_y=370
  
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.PenColor = "White"
  car_selector = Shapes.AddRectangle(33,5)
  Shapes.Move(car_selector,cs_x-2,cs_y+60)
  
  
  
  GraphicsWindow.DrawImage(car1_i, cs_x,cs_y)
  GraphicsWindow.DrawImage(car2_i, cs_x+85,cs_y)
  GraphicsWindow.DrawImage(car3_i, cs_x+170,cs_y)
  GraphicsWindow.DrawImage(car4_i, cs_x+255,cs_y)
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(cs_x+50,cs_y-30,"Выберите автомобиль")
  '////////////////////////////////Трассы
  
  GraphicsWindow.BrushColor = "SkyBlue"
  GraphicsWindow.FillRectangle(295,455,340,110)
  GraphicsWindow.PenColor = "black"
  
  GraphicsWindow.DrawLine(294,455,636,455)
  GraphicsWindow.DrawLine(636,455,636,567)
  GraphicsWindow.DrawLine(636,567,294,567)
  GraphicsWindow.DrawLine(294,567,294,455)
  
  ms_x=325
  ms_y=490
  
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(ms_x+70,ms_y-30,"Выберите трассу")
  
  GraphicsWindow.DrawImage(w1_small_i,ms_x,ms_y)
  GraphicsWindow.DrawImage(w2_small_i,ms_x+102,ms_y)
  GraphicsWindow.DrawImage(w3_small_i,ms_x+204,ms_y)
  
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.PenColor = "White"
  map_selector = Shapes.AddRectangle(83,5)
  Shapes.Move(map_selector,ms_x-2,ms_y+60)
  '////////////////////////////////Сложность
  
  GraphicsWindow.BrushColor = "SkyBlue"
  GraphicsWindow.FillRectangle(295,576,340,83)
  GraphicsWindow.PenColor = "black"
  
  GraphicsWindow.DrawLine(294,575,636,575)
  GraphicsWindow.DrawLine(636,575,636,660)
  GraphicsWindow.DrawLine(294,660,636,660)
  GraphicsWindow.DrawLine(294,575,294,660)
  
  ds_x=325
  ds_y=615
  
  GraphicsWindow.BrushColor = "ForestGreen"
  GraphicsWindow.FillRectangle(ds_x,ds_y,80,25)
  GraphicsWindow.FillRectangle(ds_x+102,ds_y,80,25)
  GraphicsWindow.FillRectangle(ds_x+204,ds_y,80,25)
  GraphicsWindow.FontSize = 18
  GraphicsWindow.BrushColor = "white"
  GraphicsWindow.FontBold = 0
  GraphicsWindow.DrawText(ds_x+8,ds_y+2,"Низкая")
  GraphicsWindow.DrawText(ds_x+6+102,ds_y+2,"Средняя")
  GraphicsWindow.DrawText(ds_x+6+204,ds_y+2,"Высокая")
  
  GraphicsWindow.PenColor = "white"
  diff_selector = Shapes.AddRectangle(83,5)
  Shapes.Move(diff_selector,ds_x+100,ds_y+30)
  
  GraphicsWindow.FontBold = 1
  GraphicsWindow.DrawText(ds_x+50,ds_y-35,"Выберите сложность")
  
  '/////////////////////////////////Кнопки
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.PenColor = "Black"
  GraphicsWindow.FillRectangle(295,690,100,40)
  GraphicsWindow.DrawLine(294,689,396,689)
  GraphicsWindow.DrawLine(396,689,396,731)
  GraphicsWindow.DrawLine(396,731,294,731)
  GraphicsWindow.DrawLine(294,731,294,689)
  GraphicsWindow.FontSize = 32
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(300,690,"Назад")
  
  GraphicsWindow.BrushColor = "Tomato"
  GraphicsWindow.FillRectangle(535,690,100,40)
  GraphicsWindow.DrawLine(534,689,636,689)
  GraphicsWindow.DrawLine(636,689,636,731)
  GraphicsWindow.DrawLine(636,731,534,731)
  GraphicsWindow.DrawLine(534,731,534,689)
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(543,690,"Старт")
  
EndSub

Sub click_race_set
  
  
  If (GraphicsWindow.MouseX>cs_x) And (GraphicsWindow.MouseX<cs_x+30) And (GraphicsWindow.MouseY>cs_y) And (GraphicsWindow.MouseY<cs_y+56) Then
    Shapes.Animate(car_selector,cs_x-2,cs_y+60,200)
    pcar=1
  ElseIf (GraphicsWindow.MouseX>cs_x+85) And (GraphicsWindow.MouseX<cs_x+115) And (GraphicsWindow.MouseY>cs_y) And (GraphicsWindow.MouseY<cs_y+56) Then
    Shapes.Animate(car_selector,cs_x-2+85,cs_y+60,200)
    pcar=2
  ElseIf (GraphicsWindow.MouseX>cs_x+170) And (GraphicsWindow.MouseX<cs_x+200) And (GraphicsWindow.MouseY>cs_y) And (GraphicsWindow.MouseY<cs_y+56) Then  
    Shapes.Animate(car_selector,cs_x-2+170,cs_y+60,200)
    pcar=3
  ElseIf (GraphicsWindow.MouseX>cs_x+255) And (GraphicsWindow.MouseX<cs_x+285) And (GraphicsWindow.MouseY>cs_y) And (GraphicsWindow.MouseY<cs_y+56) Then  
    Shapes.Animate(car_selector,cs_x-2+255,cs_y+60,200)
    pcar=4
    
  ElseIf (GraphicsWindow.MouseX>ms_x) And (GraphicsWindow.MouseX<ms_x+80) And (GraphicsWindow.MouseY>ms_y) And (GraphicsWindow.MouseY<ms_y+54) Then
    Shapes.Animate(map_selector,ms_x-2,ms_y+60,200)
    map=1
  ElseIf (GraphicsWindow.MouseX>ms_x+102) And (GraphicsWindow.MouseX<ms_x+182) And (GraphicsWindow.MouseY>ms_y) And (GraphicsWindow.MouseY<ms_y+54) Then
    Shapes.Animate(map_selector,ms_x-2+102,ms_y+60,200)
    map=2
  ElseIf (GraphicsWindow.MouseX>ms_x+204) And (GraphicsWindow.MouseX<ms_x+284) And (GraphicsWindow.MouseY>ms_y) And (GraphicsWindow.MouseY<ms_y+54) Then
    Shapes.Animate(map_selector,ms_x-2+204,ms_y+60,200)
    map=3  
    
  ElseIf (GraphicsWindow.MouseX>ds_x) And (GraphicsWindow.MouseX<ds_x+80) And (GraphicsWindow.MouseY>ds_y) And (GraphicsWindow.MouseY<ds_y+25) Then
    Shapes.Animate(diff_selector,ds_x-2,ds_y+30,200)
    diff=1
  ElseIf (GraphicsWindow.MouseX>ds_x+102) And (GraphicsWindow.MouseX<ds_x+182) And (GraphicsWindow.MouseY>ds_y) And (GraphicsWindow.MouseY<ds_y+25) Then
    Shapes.Animate(diff_selector,ds_x-2+102,ds_y+30,200)
    diff=2
  ElseIf (GraphicsWindow.MouseX>ds_x+204) And (GraphicsWindow.MouseX<ds_x+284) And (GraphicsWindow.MouseY>ds_y) And (GraphicsWindow.MouseY<ds_y+25) Then
    Shapes.Animate(diff_selector,ds_x-2+204,ds_y+30,200)
    diff=3    
    
  ElseIf (GraphicsWindow.MouseX>295) And (GraphicsWindow.MouseX<395) And (GraphicsWindow.MouseY>689) And (GraphicsWindow.MouseY<731) Then
    init_mm()    
  ElseIf (GraphicsWindow.MouseX>535) And (GraphicsWindow.MouseX<635) And (GraphicsWindow.MouseY>689) And (GraphicsWindow.MouseY<731) Then
    If (map=1) then
      draw_w1()   
    ElseIf (map=2) then
      draw_w2()
    ElseIf (map=3) then
      draw_w3()
    EndIf
  EndIf
EndSub




Sub draw_w1
  isplay=0
  gen_enem()
  already_play = 0
  race_start[1]=-1
  
  GraphicsWindow.Clear()
  GraphicsWindow.DrawImage(w1_i,0,0)
  draw_b_panel()
  
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.PenColor = "Black"
  
  car_b_line[1] = Shapes.AddRectangle(80,5)
  car_b_line[2] = Shapes.AddRectangle(80,5)
  car_b_line[3] = Shapes.AddRectangle(80,5)
  car_b_line[4] = Shapes.AddRectangle(80,5)
  GraphicsWindow.BrushColor = "Green"
  GraphicsWindow.PenColor = "Green"
  car_g_line[1] = Shapes.AddRectangle(80,5)
  car_g_line[2] = Shapes.AddRectangle(80,5)
  car_g_line[3] = Shapes.AddRectangle(80,5)
  car_g_line[4] = Shapes.AddRectangle(80,5)
  
  If (fcar1<>1) And (fcar2<>1) then
    car[1] = Shapes.AddImage(car1_i)
  EndIf
  If (fcar1<>2) And (fcar2<>2) then
    car[2] = Shapes.AddImage(car2_i)
  EndIf
  If (fcar1<>3) And (fcar2<>3) then
    car[3] = Shapes.AddImage(car3_i)
  EndIf
  If (fcar1<>4) And (fcar2<>4) then
    car[4] = Shapes.AddImage(car4_i)
  EndIf
  
  
  
  If (fcar1<>1) And (fcar2<>1) then
    Shapes.Move(car[1],40,550)
  EndIf
  If (fcar1<>2) And (fcar2<>2) then
    Shapes.Move(car[2],130,500)
  EndIf
  If (fcar1<>3) And (fcar2<>3) then
    Shapes.Move(car[3],40,450)
  EndIf
  If (fcar1<>4) And (fcar2<>4) then
    Shapes.Move(car[4],130,400)
  EndIf
  
  tb = Shapes.AddRectangle(0,0)
  Shapes.Move(tb,500,500)
  
EndSub

Sub draw_w2
  isplay=0
  gen_enem()
  already_play = 0
  race_start[1]=-1
  
  GraphicsWindow.Clear()
  GraphicsWindow.DrawImage(w2_i,0,0)
  draw_b_panel()
  
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.PenColor = "Black"
  
  car_b_line[1] = Shapes.AddRectangle(80,5)
  car_b_line[2] = Shapes.AddRectangle(80,5)
  car_b_line[3] = Shapes.AddRectangle(80,5)
  car_b_line[4] = Shapes.AddRectangle(80,5)
  GraphicsWindow.BrushColor = "Green"
  GraphicsWindow.PenColor = "Green"
  car_g_line[1] = Shapes.AddRectangle(80,5)
  car_g_line[2] = Shapes.AddRectangle(80,5)
  car_g_line[3] = Shapes.AddRectangle(80,5)
  car_g_line[4] = Shapes.AddRectangle(80,5)
  
  If (fcar1<>1) And (fcar2<>1) then
    car[1] = Shapes.AddImage(car1_i)
  EndIf
  If (fcar1<>2) And (fcar2<>2) then
    car[2] = Shapes.AddImage(car2_i)
  EndIf
  If (fcar1<>3) And (fcar2<>3) then
    car[3] = Shapes.AddImage(car3_i)
  EndIf
  If (fcar1<>4) And (fcar2<>4) then
    car[4] = Shapes.AddImage(car4_i)
  EndIf
  
  
  
  If (fcar1<>1) And (fcar2<>1) then
    Shapes.Move(car[1],20,550)
  EndIf
  If (fcar1<>2) And (fcar2<>2) then
    Shapes.Move(car[2],110,500)
  EndIf
  If (fcar1<>3) And (fcar2<>3) then
    Shapes.Move(car[3],20,450)
  EndIf
  If (fcar1<>4) And (fcar2<>4) then
    Shapes.Move(car[4],110,400)
  EndIf
  
  tb = Shapes.AddRectangle(0,0)
  Shapes.Move(tb,500,500)
EndSub

Sub draw_w3
  isplay=0
  gen_enem()
  already_play = 0
  race_start[1]=-1
  
  GraphicsWindow.Clear()
  GraphicsWindow.DrawImage(w3_i,0,0)
  draw_b_panel()
  
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.PenColor = "Black"
  
  car_b_line[1] = Shapes.AddRectangle(80,5)
  car_b_line[2] = Shapes.AddRectangle(80,5)
  car_b_line[3] = Shapes.AddRectangle(80,5)
  car_b_line[4] = Shapes.AddRectangle(80,5)
  GraphicsWindow.BrushColor = "Green"
  GraphicsWindow.PenColor = "Green"
  car_g_line[1] = Shapes.AddRectangle(80,5)
  car_g_line[2] = Shapes.AddRectangle(80,5)
  car_g_line[3] = Shapes.AddRectangle(80,5)
  car_g_line[4] = Shapes.AddRectangle(80,5)
  
  If (fcar1<>1) And (fcar2<>1) then
    car[1] = Shapes.AddImage(car1_i)
  EndIf
  If (fcar1<>2) And (fcar2<>2) then
    car[2] = Shapes.AddImage(car2_i)
  EndIf
  If (fcar1<>3) And (fcar2<>3) then
    car[3] = Shapes.AddImage(car3_i)
  EndIf
  If (fcar1<>4) And (fcar2<>4) then
    car[4] = Shapes.AddImage(car4_i)
  EndIf
  
  
  If (fcar1<>1) And (fcar2<>1) then
    Shapes.Move(car[1],20,550)
  EndIf
  If (fcar1<>2) And (fcar2<>2) then
    Shapes.Move(car[2],110,500)
  EndIf
  If (fcar1<>3) And (fcar2<>3) then
    Shapes.Move(car[3],20,450)
  EndIf
  If (fcar1<>4) And (fcar2<>4) then
    Shapes.Move(car[4],110,400)
  EndIf
  
  tb = Shapes.AddRectangle(0,0)
  Shapes.Move(tb,500,500)
EndSub


Sub gen_enem
  If (enemies_number=2) then
    gener = 1
    While (gener=1)
      fcar1 = Math.GetRandomNumber(4)
      If (fcar1<>pcar) Then
        gener = 0
      EndIf
    EndWhile
  ElseIf (enemies_number=1) then
    gener = 1
    While (gener=1)
      fcar1 = Math.GetRandomNumber(4)
      If (fcar1<>pcar) Then
        gener = 0
      EndIf
    EndWhile 
    gener = 1
    While (gener=1)
      fcar2 = Math.GetRandomNumber(4)
      If (fcar2<>pcar) And (fcar2<>fcar1) Then
        gener = 0
      EndIf
    EndWhile 
  ElseIf (enemies_number=3) then
    fcar1=500
    fcar2=500
  EndIf
  
EndSub




'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'/////////////////////////////////////////////////////////////////Главные игровые функции///////////////////////////////////////////////////////////////////////
'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub game
  GraphicsWindow.KeyDown = turn_on
  GraphicsWindow.KeyUp = turn_off
  While (1=1) 
    If (isplay=1) then
      If (key=1) Then
        mod_player()
      EndIf
      
      coll()
      
      If (map=1) then
        ai_w1()
      ElseIf (map=2) then
        ai_w2()
      ElseIf (map=3) then
        ai_w3()
      EndIf
      
      
      If (map=1) then
        cp_check_w1()
      ElseIf (map=2) then
        cp_check_w2()
      ElseIf (map=3) then
        cp_check_w3()
      EndIf
      
      move_cars()
      move_b()
      move_r()
      
      
      update_panel()
      For i=1 To 4
        If (car_angle[i]>360) then
          car_angle[i] = car_angle[i] - 360
        ElseIf (car_angle[i]<0) then
          car_angle[i] = car_angle[i] + 360  
        EndIf
      EndFor
      
      Program.Delay(pDelay)
    EndIf
  EndWhile   
EndSub


Sub draw_b_panel
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.FillRectangle(0,700,1030,80)
  
  GraphicsWindow.FontSize = 16
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(840,705,"Чтобы выйти в главное")
  GraphicsWindow.DrawText(840,720,"меню - нажмите Esc")
  GraphicsWindow.FontSize = 12
  GraphicsWindow.DrawText(990,755,"v"+version)
  
  GraphicsWindow.BrushColor = "Black"
  GraphicsWindow.DrawLine(0,699,1035,699)
  GraphicsWindow.DrawLine(830,699,830,780)
  
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.FontSize = 32
  GraphicsWindow.DrawText(100,705,"Для начала гонки нажмите пробел")
  GraphicsWindow.FontSize = 24
  GraphicsWindow.DrawText(50,740,"Вы также можете нажимать пробел чтобы ставить игру на паузу")
  
EndSub

Sub update_panel
  GraphicsWindow.BrushColor = "MediumSeaGreen"
  GraphicsWindow.FillRectangle(0,700,830,80)
  
  GraphicsWindow.FontSize = 22
  GraphicsWindow.BrushColor = "White"
  GraphicsWindow.DrawText(20,725,"Жизни: "+hp[pcar])
  
  GraphicsWindow.DrawText(190,710,"Патроны: "+ammo_bullets_counter[pcar])
  GraphicsWindow.DrawText(190,735,"Ракеты: "+ammo_rockets_counter[pcar])
  
  time = Clock.ElapsedMilliseconds- start_time
  time = time / 1000
  GraphicsWindow.DrawText(370,710,"Время: "+ time)
  
  For i=1 to 4
    
    If (laps[i]=10) Then
      car_finished[i]=1
    EndIf
    
  EndFor
  
  find_pos()
  
  
  If (laps[pcar]>=1) then
    can_fire=1
  EndIf
  
  If (laps[pcar]=2) then
    isplay = 0
    write_highscore()
    
    'If (ppos=1) then
    '  GraphicsWindow.ShowMessage("Вы приехали первым!","Результат")
    'elseif (ppos=2) then
    '  GraphicsWindow.ShowMessage("Вы приехали вторым!","Результат")
    ' elseif (ppos=3) then
    '  GraphicsWindow.ShowMessage("Вы приехали третьим!","Результат")
    ' elseif (ppos=4) then
    '  GraphicsWindow.ShowMessage("Вы приехали четвертым!","Результат")
    ' EndIf
    
    init_mm()
  EndIf
  
  If (laps[pcar]>=0) then
    GraphicsWindow.DrawText(370,735,"Круги: "+ laps[pcar] + "/10")
  else
    GraphicsWindow.DrawText(370,735,"Круги: "+ "0" + "/10")
  Endif
  GraphicsWindow.DrawText(580,725,"Позиция: "+ ppos)
  
EndSub


Sub write_highscore
  If (damage<>-1) then
    For i=1 to 10
      If (highscore[i][1]<>"-") then
        g_hs[i][1] = highscore[i][1]
        g_hs[i][2] = highscore[i][2]
        g_hs[i][3] = highscore[i][3] 
      Else 
        g_hs[i][1] = highscore[i][1]
        g_hs[i][2] = 1000000
        g_hs[i][3] = 1
      EndIf   
    EndFor
    
    g_hs[11][1] = playerName
    g_hs[11][2] = cps[ cpl[pcar][1] ][pcar] /1000
    g_hs[11][3] = damage   
    
    GraphicsWindow.ShowMessage(g_hs[11][2],"ass")
    
    For i=1 to 10
      For j=i To 1 Step -1
        If ( (g_hs[j][3]/g_hs[j][2]) < (g_hs[j+1][3]/g_hs[j+1][2])) then
          temp = g_hs[j][1]
          g_hs[j][1] = g_hs[j+1][1]
          g_hs[j+1][1] = temp
          
          temp = g_hs[j][2]
          g_hs[j][2] = g_hs[j+1][2]
          g_hs[j+1][2] = temp
          
          temp = g_hs[j][3]
          g_hs[j][3] = g_hs[j+1][3]
          g_hs[j+1][3] = temp
        EndIf
      EndFor
    EndFor
    
    For i=1 to 10
      If (g_hs[i][1]<>"-") then
        highscore[i][1] = g_hs[i][1]
        highscore[i][2] = g_hs[i][2]
        highscore[i][3] = g_hs[i][3]
      Else
        highscore[i][1] = "-"
        highscore[i][2] = "-"
        highscore[i][3] = "-"
      EndIf
    EndFor
    
    j=1
    For cnt=10 To 42 Step 3
      
' The following line could be harmful and has been automatically commented.
'       File.WriteLine(df,cnt,highscore[j][1])
' The following line could be harmful and has been automatically commented.
'       File.WriteLine(df,cnt+1,highscore[j][2])
' The following line could be harmful and has been automatically commented.
'       File.WriteLine(df,cnt+2,highscore[j][3])
      
      j=j+1
    EndFor
  EndIf
  
EndSub


Sub find_pos
  For i=1 to 4
    If (i<>fcar1) And (i<>fcar2) then
      cur_pos[i][1] = cpl[i][1]           'Посл. чекпоинт
      cur_pos[i][2] = cps[ cpl[i][1] ][i] 'Время
      cur_pos[i][3] = i                   'Машина
    EndIf
  EndFor 
  
  For i=1 to 4
    If (i=fcar1) Or (i=fcar2) Or (car_alive[i]=0) then
      cur_pos[i][1] = -1          
      cur_pos[i][2] = -1
      cur_pos[i][3] = -1
    EndIf
  EndFor 
  
  
  For i=1 to 3
    
    For j=i To 1 Step -1    
      If (cur_pos[j][1]>cur_pos[j+1][1]) Then
        temp = cur_pos[j][1]
        cur_pos[j][1] = cur_pos[j+1][1]
        cur_pos[j+1][1] = temp
        
        temp = cur_pos[j][2]
        cur_pos[j][2] = cur_pos[j+1][2]
        cur_pos[j+1][2] = temp
        
        temp = cur_pos[j][3]
        cur_pos[j][3] = cur_pos[j+1][3]
        cur_pos[j+1][3] = temp
      EndIf  
    EndFor
    
  EndFor
  
  
  For i=1 to 20 
    For j=1 To 3
      If (cur_pos[j][1] = cur_pos[j+1][1]) And (cur_pos[j][2] < cur_pos[j+1][2]) then
        
        temp = cur_pos[j][2]
        cur_pos[j][2] = cur_pos[j+1][2]
        cur_pos[j+1][2] = temp
        
        temp = cur_pos[j][3]
        cur_pos[j][3] = cur_pos[j+1][3]
        cur_pos[j+1][3] = temp
      EndIf
    EndFor
  EndFor
  
  For i=1 to 4
    If (cur_pos[i][3]=pcar) then
      If (i=4) then
        ppos=1
      ElseIf (i=3) then
        ppos=2
      ElseIf (i=2) then
        ppos=3
      ElseIf (i=1) then
        ppos=4
      EndIf
    EndIf
  EndFor
  
  
EndSub



Sub turn_on
  key = 1
  If (GraphicsWindow.LastKey = "Space")  Then   
    If (already_play=1) then
      If (isplay=0) then
        isplay=1
      Else 
        isplay=0
      EndIf
    Else
      race_str()
    EndIf
  EndIf  
EndSub
Sub turn_off
  key = 0
EndSub


Sub race_str
  While (already_play=0)
    If (race_start[1]=-1) Then
      race_start[1]=0
      race_start[2]= Clock.ElapsedMilliseconds
    Else
      race_start[1] = race_start[1] + Clock.ElapsedMilliseconds - race_start[2]
      race_start[2] =  Clock.ElapsedMilliseconds
    EndIf
    
    If (race_start[1]<1000) And (race_start[1]>0)  Then
      GraphicsWindow.BrushColor = "MediumSeaGreen"
      GraphicsWindow.FillRectangle(0,700,830,80)
      GraphicsWindow.FontSize = 36
      GraphicsWindow.BrushColor = "White"
      GraphicsWindow.DrawText(400,715,"3")
      rstr_cnt = 1
    EndIf
    
    If (race_start[1]>=1000) And (race_start[1]<2000)    Then
      GraphicsWindow.BrushColor = "MediumSeaGreen"
      GraphicsWindow.FillRectangle(0,700,830,80)
      GraphicsWindow.FontSize = 36
      GraphicsWindow.BrushColor = "White"
      GraphicsWindow.DrawText(400,715,"2")
      rstr_cnt = 2
    EndIf 
    
    If (race_start[1]>=2000) And (race_start[1]<3000)    Then
      GraphicsWindow.BrushColor = "MediumSeaGreen"
      GraphicsWindow.FillRectangle(0,700,830,80)
      GraphicsWindow.FontSize = 36
      GraphicsWindow.BrushColor = "White"
      GraphicsWindow.DrawText(400,715,"1")
      rstr_cnt = 3
    EndIf 
    
    If (race_start[1]>=3000) Then
      already_play=1
      isplay=1
      start_time=Clock.ElapsedMilliseconds
      Sound.PlayBellRing()
    EndIf 
  EndWhile
  
EndSub


'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'/////////////////////////////////////////////////////////////////Функции управления игроком///////////////////////////////////////////////////////////////////
'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



Sub mod_player
  
  If (GraphicsWindow.LastKey = rightKey) And (car_alive[pcar]=1) Then
    what_car = pcar
    car_angle[pcar] = car_angle[pcar] +8
    turn_cars()
  EndIf
  
  If (GraphicsWindow.LastKey = leftKey) And (car_alive[pcar]=1)  Then
    what_car = pcar
    car_angle[pcar] = car_angle[pcar] -8
    turn_cars()
  EndIf
  
  If (GraphicsWindow.LastKey = upKey) And (car_speed[pcar]<10) Then
    car_speed[pcar]=car_speed[pcar]+1
  EndIf
  
  
  If (GraphicsWindow.LastKey = downKey) And (car_speed[pcar]>-3)  Then
    car_speed[pcar]=car_speed[pcar]-1
    
  EndIf
  
  If (GraphicsWindow.LastKey = bulletsKey)  Then
    
    what_car = pcar
    add_bullet()        
    
  EndIf   
  
  If (GraphicsWindow.LastKey = rocketsKey)  Then   
    what_car = pcar
    add_rocket() 
    
  EndIf  
  
  If (GraphicsWindow.LastKey = "Escape")  Then   
    GraphicsWindow.Clear()
    init_mm()
  EndIf  
  
EndSub




